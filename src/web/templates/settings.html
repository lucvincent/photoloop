<!-- Copyright (c) 2025 Luc Vincent. All Rights Reserved. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoLoop Dashboard</title>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a1a2e">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PhotoLoop">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-title">
                <img src="{{ url_for('static', filename='logo.svg') }}" alt="PhotoLoop">
                <h1>PhotoLoop<span class="title-dashboard"> Dashboard</span></h1>
            </div>
            <div id="status-indicator" class="status">Loading...</div>
        </header>

        <nav class="tabs">
            <button class="tab active" data-tab="control">Control</button>
            <button class="tab" data-tab="albums">Albums</button>
            <button class="tab" data-tab="display">Display</button>
            <button class="tab" data-tab="schedule">Schedule</button>
            <button class="tab" data-tab="cache">Cache</button>
        </nav>

        <!-- Control Tab -->
        <section id="control" class="tab-content active">
            <h2>Photo Control</h2>
            <div class="control-buttons" id="photo-control-buttons" style="margin-bottom: 8px;">
                <button id="btn-prev" class="btn btn-primary photo-control-btn"><span class="btn-icon">‚èÆ</span><span class="btn-text">Previous</span></button>
                <button id="btn-pause" class="btn btn-primary photo-control-btn"><span class="btn-icon">‚è∏</span><span class="btn-text">Pause</span></button>
                <button id="btn-next" class="btn btn-primary photo-control-btn"><span class="btn-icon">‚è≠</span><span class="btn-text">Next</span></button>
            </div>
            <p class="help-text" id="photo-control-status">
                Use these controls to navigate photos or pause the slideshow on a specific photo.
            </p>

            <h2>Slideshow Control</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 8px;">
                <div class="control-buttons" style="margin: 0;">
                    <button id="btn-start" class="btn btn-success">Start</button>
                    <button id="btn-stop" class="btn btn-danger">Stop</button>
                </div>
                <span id="no-content-msg" class="help-text" style="display: none; color: var(--warning);">Enable albums and sync to download photos.</span>
                <label class="checkbox-inline">
                    <input type="checkbox" id="schedule-enabled-control"
                           {% if config.schedule.enabled %}checked{% endif %}>
                    Schedule Enabled
                </label>
            </div>

            <div class="status-box" style="margin-top: 20px;">
                <h3 style="margin-top: 0;">Current Status: <span id="state" class="status-badge">-</span></h3>
                <div id="current-status">
                    <p><strong>Next Change:</strong> <span id="next-transition">-</span></p>
                    <p><strong>Photos Cached:</strong> <span id="photo-count">-</span></p>
                    <p><strong>Cache Size:</strong> <span id="cache-size">-</span> MB</p>
                </div>
            </div>

            <h3>Album Sync</h3>
            <p class="help-text" style="margin-bottom: 12px;">
                Only enabled sources (marked "Show" in the Albums tab) will be synced.
            </p>
            <div class="form-group" style="margin-bottom: 12px;">
                <label class="checkbox-inline">
                    <input type="checkbox" id="update-all-captions">
                    Update all metadata from Google Photos
                </label>
                <p class="help-text" style="margin: 4px 0 0 26px;">
                    Check this to re-fetch metadata for all photos (slower). Otherwise, only new photos get metadata.
                </p>
            </div>
            <button id="btn-sync" class="btn btn-primary">Sync Now</button>
            <div id="sync-progress" class="sync-progress-box">
                <div id="sync-stage">Starting sync...</div>
                <div id="sync-details"></div>
                <div class="progress-bar-container">
                    <div id="sync-progress-bar"></div>
                </div>
                <div id="sync-progress-text"></div>
            </div>
        </section>

        <!-- Albums Tab -->
        <section id="albums" class="tab-content">
            <h2>Photo Sources</h2>

            <div class="source-type-tabs" style="display: flex; gap: 0; margin-bottom: 15px;">
                <button class="source-tab active" data-source="google" style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 8px 0 0 8px; background: var(--sage-primary); color: white; cursor: pointer;">Google Photos</button>
                <button class="source-tab" data-source="local" style="flex: 1; padding: 10px; border: 1px solid var(--border); border-left: none; border-radius: 0 8px 8px 0; background: var(--card-bg); color: var(--text-secondary); cursor: pointer;">Local Directory</button>
            </div>

            <!-- Google Photos Input -->
            <div id="google-input" class="source-input">
                <div class="form-group">
                    <label for="new-album-url">Album URL</label>
                    <input type="url" id="new-album-url" placeholder="https://photos.app.goo.gl/...">
                </div>
                <div class="form-group">
                    <label for="new-album-name">Album Name (optional)</label>
                    <input type="text" id="new-album-name" placeholder="My Album">
                </div>
                <button id="btn-add-album" class="btn btn-primary">Add Google Album</button>
            </div>

            <!-- Local Directory Input -->
            <div id="local-input" class="source-input" style="display: none;">
                <div class="form-group">
                    <label for="new-local-path">Directory Path</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="new-local-path" placeholder="/home/pi/photos" style="flex: 1;">
                        <button id="btn-browse-dir" class="btn btn-small" type="button" style="align-self: center;">Browse...</button>
                    </div>
                    <p class="help-text" style="margin-top: 4px; font-size: 12px;">Enter the full path or use Browse to select a directory.</p>
                </div>
                <div class="form-group">
                    <label for="new-local-name">Display Name (optional)</label>
                    <input type="text" id="new-local-name" placeholder="My Local Photos">
                </div>
                <button id="btn-add-local" class="btn btn-primary">Add Local Directory</button>
            </div>

            <h3>Configured Sources</h3>
            <p class="hint">Changes in source selection take effect immediately.</p>
            <ul id="album-list" class="album-list">
                <!-- Albums will be loaded here -->
            </ul>

            <!-- Directory Browser Modal -->
            <div id="dir-browser-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <h3>Select Directory</h3>
                    <div id="browser-path" class="browser-path">/home</div>
                    <button id="btn-browser-up" class="btn btn-small" type="button">‚Üë Parent Directory</button>
                    <ul id="browser-list" class="browser-list">
                        <!-- Directories will be loaded here -->
                    </ul>
                    <p class="help-text" style="margin-top: 8px; font-size: 11px;">
                        Photo counts shown are for that directory only. Subdirectories will be included when syncing.
                    </p>
                    <div class="modal-buttons">
                        <button id="btn-browser-select" class="btn btn-primary" type="button">Select This Directory</button>
                        <button id="btn-browser-cancel" class="btn" type="button">Cancel</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Display Tab -->
        <section id="display" class="tab-content">
            <h2>Display Settings</h2>
            <p class="hint">Changes take effect immediately after saving.</p>

            <div class="form-group">
                <label for="photo-duration">Photo Duration (seconds)</label>
                <input type="number" id="photo-duration" min="5" max="300"
                       value="{{ config.display.photo_duration_seconds }}">
            </div>

            <div class="form-group">
                <label for="transition-type">Transition Type</label>
                <select id="transition-type">
                    <option value="fade" {% if config.display.transition_type == 'fade' %}selected{% endif %}>Fade</option>
                    <option value="slide_left" {% if config.display.transition_type == 'slide_left' %}selected{% endif %}>Slide Left</option>
                    <option value="slide_right" {% if config.display.transition_type == 'slide_right' %}selected{% endif %}>Slide Right</option>
                    <option value="slide_up" {% if config.display.transition_type == 'slide_up' %}selected{% endif %}>Slide Up</option>
                    <option value="slide_down" {% if config.display.transition_type == 'slide_down' %}selected{% endif %}>Slide Down</option>
                    <option value="random" {% if config.display.transition_type == 'random' %}selected{% endif %}>Random</option>
                </select>
            </div>

            <div class="form-group">
                <label for="display-order">Photo Order</label>
                <select id="display-order">
                    <option value="random" {% if config.display.order == 'random' %}selected{% endif %}>Random</option>
                    <option value="recency_weighted" {% if config.display.order == 'recency_weighted' %}selected{% endif %}>Random with Recency Bias</option>
                    <option value="alphabetical" {% if config.display.order == 'alphabetical' %}selected{% endif %}>Alphabetical (by filename)</option>
                    <option value="chronological" {% if config.display.order == 'chronological' %}selected{% endif %}>Chronological (by date)</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="overlay-enabled"
                           {% if config.overlay.enabled %}checked{% endif %}>
                    Show Date/Caption Overlay
                </label>
            </div>

            <div class="form-group" id="overlay-font-size-group" style="display: flex; align-items: center; gap: 12px;">
                <label for="overlay-font-size" style="margin: 0;">Overlay Text Size (pixels)</label>
                <input type="number" id="overlay-font-size" min="12" max="200"
                       value="{{ config.overlay.font_size }}" style="width: 100px;">
            </div>

            <button id="btn-save-display" class="btn btn-primary">Save Display Settings</button>
        </section>

        <!-- Schedule Tab -->
        <section id="schedule" class="tab-content">
            <h2>Schedule Settings</h2>
            <p class="hint">Changes take effect immediately after saving. However Slideshow Control must be used to enable/disable the schedule.</p>

            <h3>Weekday Schedule (Mon-Fri)</h3>
            <div class="time-range">
                <div class="form-group">
                    <label for="weekday-start">Start Time</label>
                    <input type="time" id="weekday-start"
                           value="{{ config.schedule.weekday.start_time }}">
                </div>
                <div class="form-group">
                    <label for="weekday-end">End Time</label>
                    <input type="time" id="weekday-end"
                           value="{{ config.schedule.weekday.end_time }}">
                </div>
            </div>

            <h3>Weekend Schedule (Sat-Sun)</h3>
            <div class="time-range">
                <div class="form-group">
                    <label for="weekend-start">Start Time</label>
                    <input type="time" id="weekend-start"
                           value="{{ config.schedule.weekend.start_time }}">
                </div>
                <div class="form-group">
                    <label for="weekend-end">End Time</label>
                    <input type="time" id="weekend-end"
                           value="{{ config.schedule.weekend.end_time }}">
                </div>
            </div>

            <div class="form-group">
                <label for="off-hours-mode">Off-Hours Display</label>
                <select id="off-hours-mode">
                    <option value="black" {% if config.schedule.off_hours_mode == 'black' %}selected{% endif %}>Black Screen</option>
                    <option value="clock" {% if config.schedule.off_hours_mode == 'clock' %}selected{% endif %}>Clock</option>
                </select>
            </div>

            <button id="btn-save-schedule" class="btn btn-primary">Save Schedule</button>
        </section>

        <!-- Cache Tab -->
        <section id="cache" class="tab-content">
            <h2>Cache Management</h2>

            <div class="status-box">
                <p><strong>Cache Directory:</strong> {{ config.cache.directory }}</p>
                <p><strong>Max Size:</strong> {{ config.cache.max_size_mb }} MB</p>
                <p><strong>Current Size:</strong> <span id="cache-size-detail">-</span></p>
                <p><strong>Photos:</strong> <span id="photo-count-detail">-</span></p>
                <p><strong>Videos:</strong> <span id="video-count-detail">-</span></p>
            </div>

            <h3>Cached Photos <span id="photo-grid-count" style="font-weight: normal; font-size: 14px; color: #81d4fa;"></span></h3>
            <p style="margin: 5px 0 10px 0; font-size: 13px; color: #888;">Newest additions first. Note: Photos deleted from local directories will show as empty frames until the next sync.</p>
            <div id="photo-grid" class="photo-grid" style="max-height: 500px; overflow-y: auto; border: 1px solid #333; border-radius: 8px; padding: 10px; background: #16213e;">
                <!-- Thumbnails will be loaded here -->
            </div>

            <button id="btn-clear-cache" class="btn btn-danger" style="margin-top: 15px;">Clear Cache</button>
        </section>

        <footer class="copyright">
            Copyright ¬© Luc Vincent, 2025 ‚Äî All Rights Reserved
        </footer>
    </div>

    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then((registration) => {
                    console.log('ServiceWorker registered:', registration.scope);
                })
                .catch((error) => {
                    console.log('ServiceWorker registration failed:', error);
                });
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // API helpers
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = { method };
            if (data) {
                options.headers = { 'Content-Type': 'application/json' };
                options.body = JSON.stringify(data);
            }
            const response = await fetch(endpoint, options);
            return response.json();
        }

        // Format ISO datetime for display (e.g., "Dec 30, 3:15 PM")
        function formatSyncTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        // Load status
        async function loadStatus() {
            try {
                const status = await apiCall('/api/status');

                if (status.schedule) {
                    // Map scheduler state to user-friendly display
                    const stateEl = document.getElementById('state');
                    const state = status.schedule.state;
                    const isPaused = status.photo_control && status.photo_control.paused;
                    const hasContent = status.has_content !== false;
                    let displayText, badgeClass;

                    if ((state === 'active' || state === 'force_on') && !hasContent) {
                        // Schedule wants to run but no content available
                        displayText = 'No Content';
                        badgeClass = 'status-badge stopped';
                    } else if (state === 'active' || state === 'force_on') {
                        if (isPaused) {
                            displayText = 'Paused';
                            badgeClass = 'status-badge paused';
                        } else {
                            displayText = 'Running';
                            badgeClass = 'status-badge running';
                        }
                    } else if (state === 'off_hours') {
                        displayText = 'Off-Hours';
                        badgeClass = 'status-badge off-hours';
                    } else if (state === 'force_off') {
                        displayText = 'Stopped';
                        badgeClass = 'status-badge stopped';
                    } else {
                        displayText = state;
                        badgeClass = 'status-badge';
                    }

                    stateEl.textContent = displayText;
                    stateEl.className = badgeClass;

                    if (status.schedule.next_transition && status.schedule.next_transition.time) {
                        const nextTime = new Date(status.schedule.next_transition.time);
                        const timeStr = nextTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        document.getElementById('next-transition').textContent =
                            `${status.schedule.next_transition.description} at ${timeStr}`;
                    } else if (status.schedule.has_override) {
                        document.getElementById('next-transition').textContent = 'None (manual control active)';
                    } else if (!status.schedule_enabled) {
                        document.getElementById('next-transition').textContent = 'None (schedule disabled)';
                    } else {
                        document.getElementById('next-transition').textContent = '-';
                    }
                }

                if (status.cache) {
                    document.getElementById('photo-count').textContent = status.cache.counts.photos;
                    document.getElementById('cache-size').textContent = status.cache.size_mb;
                    document.getElementById('photo-count-detail').textContent = status.cache.counts.photos;
                    document.getElementById('video-count-detail').textContent = status.cache.counts.videos;
                    // Show breakdown: "XX MB (downloaded: XX MB, pre-rendered: XX MB)"
                    const breakdown = status.cache.size_breakdown;
                    if (breakdown) {
                        document.getElementById('cache-size-detail').textContent =
                            `${breakdown.total} MB (downloaded: ${breakdown.downloaded} MB, pre-rendered: ${breakdown.rendered} MB)`;
                    } else {
                        document.getElementById('cache-size-detail').textContent = status.cache.size_mb + ' MB';
                    }
                }

                // Update button states based on current state
                if (status.schedule) {
                    const state = status.schedule.state;
                    const scheduleRunning = (state === 'active' || state === 'force_on');
                    const hasContent = status.has_content !== false;  // Default true if not present
                    // Effectively running only if schedule says so AND we have content
                    const isRunning = scheduleRunning && hasContent;

                    // Show Start when stopped/off-hours/no-content, Show Stop when running
                    const startBtn = document.getElementById('btn-start');
                    const stopBtn = document.getElementById('btn-stop');
                    const noContentMsg = document.getElementById('no-content-msg');

                    startBtn.style.display = isRunning ? 'none' : '';
                    stopBtn.style.display = isRunning ? '' : 'none';

                    // Disable Start and show message when no content available
                    if (!hasContent) {
                        startBtn.disabled = true;
                        startBtn.style.opacity = '0.5';
                        startBtn.style.cursor = 'not-allowed';
                        noContentMsg.style.display = '';
                    } else {
                        startBtn.disabled = false;
                        startBtn.style.opacity = '';
                        startBtn.style.cursor = '';
                        noContentMsg.style.display = 'none';
                    }
                }

                // Sync schedule enabled checkbox
                if (status.schedule_enabled !== undefined) {
                    document.getElementById('schedule-enabled-control').checked = status.schedule_enabled;
                }

                // Update photo control pause button
                if (status.photo_control) {
                    const pauseBtn = document.getElementById('btn-pause');
                    const statusEl = document.getElementById('photo-control-status');
                    if (status.photo_control.paused) {
                        pauseBtn.innerHTML = '<span class="btn-icon">‚ñ∂</span><span class="btn-text">Resume</span>';
                        pauseBtn.className = 'btn btn-primary photo-control-btn';
                        statusEl.innerHTML = '<strong style="color: var(--warning);">Slideshow paused.</strong> Click Resume to continue auto-advance.';
                        statusEl.style.color = 'var(--text-secondary)';
                    } else {
                        pauseBtn.innerHTML = '<span class="btn-icon">‚è∏</span><span class="btn-text">Pause</span>';
                        pauseBtn.className = 'btn btn-primary photo-control-btn';
                        statusEl.textContent = 'Use these controls to navigate photos or pause the slideshow on a specific photo.';
                        statusEl.style.color = '';
                    }
                }

                document.getElementById('status-indicator').textContent = 'Connected';
                document.getElementById('status-indicator').className = 'status online';
            } catch (e) {
                document.getElementById('status-indicator').textContent = 'Disconnected';
                document.getElementById('status-indicator').className = 'status offline';
            }
        }

        // Source type tab switching
        document.querySelectorAll('.source-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.source-tab').forEach(t => {
                    t.classList.remove('active');
                    t.style.background = 'var(--card-bg)';
                    t.style.color = 'var(--text-secondary)';
                });
                tab.classList.add('active');
                tab.style.background = 'var(--sage-primary)';
                tab.style.color = 'white';

                const source = tab.dataset.source;
                document.getElementById('google-input').style.display = source === 'google' ? 'block' : 'none';
                document.getElementById('local-input').style.display = source === 'local' ? 'block' : 'none';
            });
        });

        // Load albums
        async function loadAlbums() {
            const albums = await apiCall('/api/albums');
            const list = document.getElementById('album-list');
            list.innerHTML = '';
            albums.forEach((album, index) => {
                const li = document.createElement('li');
                li.dataset.index = index;
                const displayName = album.name || 'Unnamed';
                const isLocal = album.type === 'local';
                const sourceLabel = isLocal ? 'Local' : 'Google';
                const sourceLocation = isLocal ? album.path : album.url;
                const lastSynced = album.last_synced ? formatSyncTime(album.last_synced) : 'Never synced';
                li.innerHTML = `
                    <label class="album-enabled-label">
                        <input type="checkbox" class="album-enabled-checkbox"
                               data-index="${index}" ${album.enabled ? 'checked' : ''}>
                        <span>Show</span>
                    </label>
                    <div class="album-details">
                        <div class="album-name-row">
                            <span class="album-name-wrapper">
                                <span class="source-badge" style="font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 6px; background: ${isLocal ? '#6b7280' : 'var(--sage-primary)'}; color: white;">${sourceLabel}</span>
                                <span class="album-name editable" data-index="${index}">${displayName}</span>
                                <span class="album-photo-count">(${album.photo_count} photos)</span>
                            </span>
                            <span class="album-edit-wrapper hidden">
                                <input type="text" class="album-name-input" data-index="${index}"
                                       value="${album.name || ''}" placeholder="Name">
                                <button class="btn btn-small btn-save" data-index="${index}">Save</button>
                            </span>
                        </div>
                        <div class="album-url" style="font-size: 12px; color: var(--text-secondary); word-break: break-all;">${sourceLocation}</div>
                        <div class="album-last-synced" style="font-size: 11px; color: var(--text-muted);">Last synced: ${lastSynced}</div>
                    </div>
                    <button class="btn btn-small btn-danger" onclick="deleteAlbum(${index})">Delete</button>
                `;
                list.appendChild(li);
            });

            // Add event handlers for enabled checkboxes
            document.querySelectorAll('.album-enabled-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', async (e) => {
                    const index = e.target.dataset.index;
                    const enabled = e.target.checked;
                    await apiCall(`/api/albums/${index}/enabled`, 'POST', { enabled });
                });
            });

            // Click on album name to edit
            document.querySelectorAll('.album-name.editable').forEach(nameSpan => {
                nameSpan.addEventListener('click', (e) => {
                    const li = e.target.closest('li');
                    li.querySelector('.album-name-wrapper').classList.add('hidden');
                    li.querySelector('.album-edit-wrapper').classList.remove('hidden');
                    const input = li.querySelector('.album-name-input');
                    input.focus();
                    input.select();
                });
            });

            // Save button handler
            document.querySelectorAll('.btn-save').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const li = e.target.closest('li');
                    const input = li.querySelector('.album-name-input');
                    const index = input.dataset.index;
                    const name = input.value.trim();
                    await apiCall(`/api/albums/${index}/name`, 'POST', { name });
                    // Update display and switch back to view mode
                    li.querySelector('.album-name').textContent = name || 'Unnamed album';
                    li.querySelector('.album-name-wrapper').classList.remove('hidden');
                    li.querySelector('.album-edit-wrapper').classList.add('hidden');
                });
            });

            // Keyboard handlers for input
            document.querySelectorAll('.album-name-input').forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const li = e.target.closest('li');
                        li.querySelector('.btn-save').click();
                    } else if (e.key === 'Escape') {
                        // Cancel edit
                        const li = e.target.closest('li');
                        li.querySelector('.album-name-wrapper').classList.remove('hidden');
                        li.querySelector('.album-edit-wrapper').classList.add('hidden');
                    }
                });
            });
        }

        // Add Google Photos album
        document.getElementById('btn-add-album').addEventListener('click', async () => {
            const url = document.getElementById('new-album-url').value.trim();
            const name = document.getElementById('new-album-name').value.trim();
            if (!url) {
                alert('Please enter an album URL');
                return;
            }
            const result = await apiCall('/api/albums', 'POST', { url, name, type: 'google_photos' });
            if (result.error) {
                alert('Error: ' + result.error);
                return;
            }
            document.getElementById('new-album-url').value = '';
            document.getElementById('new-album-name').value = '';
            loadAlbums();
        });

        // Add local directory
        document.getElementById('btn-add-local').addEventListener('click', async () => {
            const path = document.getElementById('new-local-path').value.trim();
            const name = document.getElementById('new-local-name').value.trim();
            if (!path) {
                alert('Please enter a directory path');
                return;
            }
            const result = await apiCall('/api/albums', 'POST', { path, name, type: 'local' });
            if (result.error) {
                alert('Error: ' + result.error);
                return;
            }
            document.getElementById('new-local-path').value = '';
            document.getElementById('new-local-name').value = '';
            loadAlbums();
        });

        // Directory browser
        let currentBrowsePath = null;

        async function browsePath(path) {
            try {
                const result = await apiCall('/api/browse', 'POST', { path: path || undefined });
                if (result.error) {
                    alert('Error: ' + result.error);
                    return;
                }

                currentBrowsePath = result.current_path;
                document.getElementById('browser-path').textContent = result.current_path;

                // Update parent button visibility
                const parentBtn = document.getElementById('btn-browser-up');
                parentBtn.style.display = result.parent_path ? 'inline-block' : 'none';

                // Populate directory list
                const list = document.getElementById('browser-list');
                list.innerHTML = '';

                if (result.items.length === 0) {
                    const li = document.createElement('li');
                    li.style.color = 'var(--text-muted)';
                    li.style.fontStyle = 'italic';
                    li.textContent = 'No subdirectories';
                    list.appendChild(li);
                } else {
                    for (const item of result.items) {
                        const li = document.createElement('li');
                        let text = `üìÅ ${item.name}`;
                        if (item.photo_count !== undefined) {
                            text += `<span class="photo-count">(${item.photo_count} photos)</span>`;
                        }
                        li.innerHTML = text;
                        li.addEventListener('click', () => browsePath(item.path));
                        list.appendChild(li);
                    }
                }
            } catch (e) {
                alert('Error browsing: ' + e.message);
            }
        }

        // Browse button - open modal
        document.getElementById('btn-browse-dir').addEventListener('click', () => {
            document.getElementById('dir-browser-modal').style.display = 'flex';
            const currentPath = document.getElementById('new-local-path').value.trim();
            browsePath(currentPath || null);
        });

        // Parent directory button
        document.getElementById('btn-browser-up').addEventListener('click', () => {
            if (currentBrowsePath && currentBrowsePath !== '/') {
                const parent = currentBrowsePath.substring(0, currentBrowsePath.lastIndexOf('/')) || '/';
                browsePath(parent);
            }
        });

        // Select button - use current path
        document.getElementById('btn-browser-select').addEventListener('click', () => {
            document.getElementById('new-local-path').value = currentBrowsePath;
            document.getElementById('dir-browser-modal').style.display = 'none';
        });

        // Cancel button - close modal
        document.getElementById('btn-browser-cancel').addEventListener('click', () => {
            document.getElementById('dir-browser-modal').style.display = 'none';
        });

        // Close modal on background click
        document.getElementById('dir-browser-modal').addEventListener('click', (e) => {
            if (e.target.id === 'dir-browser-modal') {
                document.getElementById('dir-browser-modal').style.display = 'none';
            }
        });

        // Delete album
        async function deleteAlbum(index) {
            if (confirm('Delete this album?')) {
                await apiCall(`/api/albums/${index}`, 'DELETE');
                loadAlbums();
            }
        }

        // Control buttons
        document.getElementById('btn-start').addEventListener('click', () => {
            apiCall('/api/control/start', 'POST');
            setTimeout(loadStatus, 500);
        });
        document.getElementById('btn-stop').addEventListener('click', () => {
            apiCall('/api/control/stop', 'POST');
            setTimeout(loadStatus, 500);
        });
        document.getElementById('btn-next').addEventListener('click', () => {
            apiCall('/api/control/next', 'POST');
        });

        // Photo control buttons
        document.getElementById('btn-prev').addEventListener('click', () => {
            apiCall('/api/control/prev', 'POST');
        });

        document.getElementById('btn-pause').addEventListener('click', () => {
            apiCall('/api/control/toggle_pause', 'POST');
            setTimeout(loadStatus, 300);
        });

        // Schedule enabled checkbox - immediate save
        document.getElementById('schedule-enabled-control').addEventListener('change', async (e) => {
            const enabled = e.target.checked;
            await apiCall('/api/schedule/enabled', 'POST', { enabled });
            setTimeout(loadStatus, 500);
        });

        // Sync progress polling
        let syncPollInterval = null;

        async function updateSyncProgress() {
            try {
                const progress = await apiCall('/api/sync/status');
                const progressDiv = document.getElementById('sync-progress');
                const stageDiv = document.getElementById('sync-stage');
                const detailsDiv = document.getElementById('sync-details');
                const progressBar = document.getElementById('sync-progress-bar');
                const progressText = document.getElementById('sync-progress-text');
                const syncBtn = document.getElementById('btn-sync');

                if (progress.is_syncing) {
                    progressDiv.style.display = 'block';
                    syncBtn.disabled = true;
                    syncBtn.textContent = 'Syncing...';

                    if (progress.stage === 'scraping') {
                        stageDiv.textContent = `Scraping album: ${progress.album_name || 'Loading...'}`;
                        detailsDiv.textContent = `Found ${progress.urls_found} photos so far...`;
                        // Indeterminate progress during scraping
                        progressBar.style.width = '100%';
                        progressBar.style.background = 'linear-gradient(90deg, #4CAF50 25%, #8BC34A 50%, #4CAF50 75%)';
                        progressBar.style.backgroundSize = '200% 100%';
                        progressBar.style.animation = 'shimmer 1.5s infinite';
                        progressText.textContent = `Album ${progress.albums_done}/${progress.albums_total}`;
                    } else if (progress.stage === 'downloading') {
                        stageDiv.textContent = 'Downloading photos...';
                        const pct = progress.downloads_total > 0
                            ? Math.round((progress.downloads_done / progress.downloads_total) * 100)
                            : 0;
                        detailsDiv.textContent = `${progress.downloads_done} of ${progress.downloads_total} new photos`;
                        progressBar.style.width = pct + '%';
                        progressBar.style.background = '#4CAF50';
                        progressBar.style.animation = 'none';
                        progressText.textContent = pct + '%';
                    } else if (progress.stage === 'fetching_captions') {
                        stageDiv.textContent = 'Fetching metadata from Google Photos...';
                        const pct = progress.downloads_total > 0
                            ? Math.round((progress.downloads_done / progress.downloads_total) * 100)
                            : 0;
                        detailsDiv.textContent = `${progress.downloads_done} of ${progress.downloads_total} photos`;
                        progressBar.style.width = pct + '%';
                        progressBar.style.background = 'linear-gradient(90deg, var(--sage-primary), var(--sage-light))';
                        progressBar.style.animation = 'none';
                        progressText.textContent = pct + '%';
                    }
                } else if (progress.stage === 'complete') {
                    stageDiv.textContent = 'Sync complete!';
                    detailsDiv.textContent = `Found ${progress.urls_found} photos total`;
                    progressBar.style.width = '100%';
                    progressBar.style.background = '#4CAF50';
                    progressBar.style.animation = 'none';
                    progressText.textContent = '100%';
                    syncBtn.disabled = false;
                    syncBtn.textContent = 'Sync Now';

                    // Hide progress after 3 seconds
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                        loadStatus();
                    }, 3000);

                    // Stop polling
                    if (syncPollInterval) {
                        clearInterval(syncPollInterval);
                        syncPollInterval = null;
                    }
                } else {
                    // Idle state
                    progressDiv.style.display = 'none';
                    syncBtn.disabled = false;
                    syncBtn.textContent = 'Sync Now';
                    if (syncPollInterval) {
                        clearInterval(syncPollInterval);
                        syncPollInterval = null;
                    }
                }
            } catch (e) {
                console.error('Error polling sync status:', e);
            }
        }

        // Sync button
        document.getElementById('btn-sync').addEventListener('click', async () => {
            const progressDiv = document.getElementById('sync-progress');
            const stageDiv = document.getElementById('sync-stage');
            const detailsDiv = document.getElementById('sync-details');
            const progressBar = document.getElementById('sync-progress-bar');
            const updateAllCaptions = document.getElementById('update-all-captions').checked;

            // Show progress immediately
            progressDiv.style.display = 'block';
            stageDiv.textContent = 'Starting sync...';
            detailsDiv.textContent = '';
            progressBar.style.width = '0%';

            document.getElementById('btn-sync').disabled = true;
            document.getElementById('btn-sync').textContent = 'Syncing...';

            await apiCall('/api/sync', 'POST', { update_all_captions: updateAllCaptions });

            // Start polling for progress
            if (!syncPollInterval) {
                syncPollInterval = setInterval(updateSyncProgress, 1000);
            }
        });

        // Check sync status on page load and start polling if sync is in progress
        async function checkInitialSyncStatus() {
            try {
                const progress = await apiCall('/api/sync/status');
                if (progress.is_syncing && !syncPollInterval) {
                    // Sync is already running, start polling
                    syncPollInterval = setInterval(updateSyncProgress, 1000);
                }
                updateSyncProgress();
            } catch (e) {
                console.error('Error checking initial sync status:', e);
            }
        }
        checkInitialSyncStatus();

        // Load photos
        async function loadPhotos() {
            const photos = await apiCall('/api/photos');
            const grid = document.getElementById('photo-grid');
            const countSpan = document.getElementById('photo-grid-count');
            grid.innerHTML = '';

            const photoItems = photos.filter(p => p.type === 'photo');
            countSpan.textContent = `(${photoItems.length} photos)`;

            photoItems.forEach(photo => {
                const div = document.createElement('div');
                div.className = 'photo-thumb';
                div.innerHTML = `
                    <img src="/api/photos/${photo.id}/thumbnail"
                         alt="${photo.caption || ''}"
                         loading="lazy">
                    <span>${photo.caption || photo.date || ''}</span>
                `;
                grid.appendChild(div);
            });
        }

        // Clear cache button
        document.getElementById('btn-clear-cache').addEventListener('click', async () => {
            if (confirm('Are you sure you want to clear all cached photos? They will be re-downloaded on the next sync.')) {
                const btn = document.getElementById('btn-clear-cache');
                btn.disabled = true;
                btn.textContent = 'Clearing...';
                try {
                    const result = await apiCall('/api/cache/clear', 'POST');
                    if (result.success) {
                        alert('Cache cleared successfully. Run sync to re-download photos.');
                        loadStatus();
                        loadPhotos();
                    } else {
                        alert('Error: ' + (result.error || 'Unknown error'));
                    }
                } catch (e) {
                    alert('Error clearing cache: ' + e);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Clear Cache';
                }
            }
        });

        // Track display settings changes
        const displayInputs = ['photo-duration', 'transition-type', 'display-order', 'overlay-enabled', 'overlay-font-size'];
        const displayOriginalValues = {};

        function captureDisplayOriginalValues() {
            displayInputs.forEach(id => {
                const el = document.getElementById(id);
                displayOriginalValues[id] = el.type === 'checkbox' ? el.checked : el.value;
            });
        }

        function checkDisplayChanges() {
            const btn = document.getElementById('btn-save-display');
            let hasChanges = false;
            displayInputs.forEach(id => {
                const el = document.getElementById(id);
                const currentValue = el.type === 'checkbox' ? el.checked : el.value;
                if (currentValue !== displayOriginalValues[id]) {
                    hasChanges = true;
                }
            });
            btn.disabled = !hasChanges;
        }

        // Initialize original values and set up change listeners
        captureDisplayOriginalValues();
        document.getElementById('btn-save-display').disabled = true;
        displayInputs.forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('change', checkDisplayChanges);
            if (el.type === 'number' || el.type === 'text') {
                el.addEventListener('input', checkDisplayChanges);
            }
        });

        // Save display settings
        document.getElementById('btn-save-display').addEventListener('click', async () => {
            const btn = document.getElementById('btn-save-display');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const data = {
                    photo_duration_seconds: document.getElementById('photo-duration').value,
                    transition_type: document.getElementById('transition-type').value,
                    order: document.getElementById('display-order').value,
                    overlay_enabled: document.getElementById('overlay-enabled').checked,
                    overlay_font_size: document.getElementById('overlay-font-size').value
                };

                const result = await apiCall('/api/display', 'POST', data);
                if (result.success) {
                    captureDisplayOriginalValues();  // Reset tracking
                    btn.textContent = 'Saved!';
                    setTimeout(() => {
                        btn.textContent = 'Save Display Settings';
                        // Button stays disabled since no changes now
                    }, 1500);
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                    btn.textContent = 'Save Display Settings';
                    btn.disabled = false;
                }
            } catch (e) {
                alert('Error saving settings: ' + e);
                btn.textContent = 'Save Display Settings';
                btn.disabled = false;
            }
        });

        // Track schedule settings changes
        const scheduleInputs = ['weekday-start', 'weekday-end', 'weekend-start', 'weekend-end', 'off-hours-mode'];
        const scheduleOriginalValues = {};

        function captureScheduleOriginalValues() {
            scheduleInputs.forEach(id => {
                const el = document.getElementById(id);
                scheduleOriginalValues[id] = el.value;
            });
        }

        function checkScheduleChanges() {
            const btn = document.getElementById('btn-save-schedule');
            let hasChanges = false;
            scheduleInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el.value !== scheduleOriginalValues[id]) {
                    hasChanges = true;
                }
            });
            btn.disabled = !hasChanges;
        }

        // Initialize schedule tracking
        captureScheduleOriginalValues();
        document.getElementById('btn-save-schedule').disabled = true;
        scheduleInputs.forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('change', checkScheduleChanges);
            el.addEventListener('input', checkScheduleChanges);
        });

        // Save schedule settings
        document.getElementById('btn-save-schedule').addEventListener('click', async () => {
            const btn = document.getElementById('btn-save-schedule');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const data = {
                    weekday_start: document.getElementById('weekday-start').value,
                    weekday_end: document.getElementById('weekday-end').value,
                    weekend_start: document.getElementById('weekend-start').value,
                    weekend_end: document.getElementById('weekend-end').value,
                    off_hours_mode: document.getElementById('off-hours-mode').value
                };

                const result = await apiCall('/api/schedule', 'POST', data);
                if (result.success) {
                    captureScheduleOriginalValues();
                    btn.textContent = 'Saved!';
                    setTimeout(() => {
                        btn.textContent = 'Save Schedule';
                    }, 1500);
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                    btn.textContent = 'Save Schedule';
                    btn.disabled = false;
                }
            } catch (e) {
                alert('Error saving schedule: ' + e);
                btn.textContent = 'Save Schedule';
                btn.disabled = false;
            }
        });

        // Initialize
        loadStatus();
        loadAlbums();
        loadPhotos();
        setInterval(loadStatus, 10000);
    </script>
</body>
</html>
