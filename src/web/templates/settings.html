<!-- Copyright (c) 2025 Luc Vincent. All Rights Reserved. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoLoop Dashboard</title>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a1a2e">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PhotoLoop">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-title">
                <img src="{{ url_for('static', filename='logo.svg') }}" alt="PhotoLoop">
                <h1>PhotoLoop Dashboard</h1>
            </div>
            <div id="status-indicator" class="status">Loading...</div>
        </header>

        <nav class="tabs">
            <button class="tab active" data-tab="control">Control</button>
            <button class="tab" data-tab="albums">Albums</button>
            <button class="tab" data-tab="display">Display</button>
            <button class="tab" data-tab="schedule">Schedule</button>
            <button class="tab" data-tab="cache">Cache</button>
        </nav>

        <!-- Control Tab -->
        <section id="control" class="tab-content active">
            <h2>Photo Control</h2>
            <div class="control-buttons" id="photo-control-buttons" style="margin-bottom: 8px;">
                <button id="btn-prev" class="btn">Previous</button>
                <button id="btn-pause" class="btn btn-primary">Pause</button>
                <button id="btn-next" class="btn">Next</button>
            </div>
            <p class="help-text" id="photo-control-status">
                Use these controls to navigate photos or pause the slideshow on a specific photo.
            </p>

            <h2>Slideshow Control</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 8px;">
                <div class="control-buttons" style="margin: 0;">
                    <button id="btn-start" class="btn btn-success">Start</button>
                    <button id="btn-stop" class="btn btn-danger">Stop</button>
                    <button id="btn-pause-schedule" class="btn btn-primary" style="display: none;">Pause Schedule</button>
                </div>
                <label class="checkbox-inline">
                    <input type="checkbox" id="schedule-enabled-control"
                           {% if config.schedule.enabled %}checked{% endif %}>
                    Schedule Enabled
                </label>
            </div>
            <div id="temp-override-info" class="help-text" style="display: none; color: var(--warning);">
                <strong>Temporary override active.</strong> Slideshow will resume normal schedule at <span id="temp-override-until">-</span>.
                <button id="btn-resume-schedule" class="btn btn-small" style="margin-left: 10px;">Resume Schedule Now</button>
            </div>

            <div class="status-box" style="margin-top: 20px;">
                <h3 style="margin-top: 0;">Current Status: <span id="state" class="status-badge">-</span></h3>
                <div id="current-status">
                    <p><strong>Next Change:</strong> <span id="next-transition">-</span></p>
                    <p><strong>Photos Cached:</strong> <span id="photo-count">-</span></p>
                    <p><strong>Cache Size:</strong> <span id="cache-size">-</span> MB</p>
                </div>
            </div>

            <h3>Album Sync</h3>
            <div class="form-group" style="margin-bottom: 12px;">
                <label class="checkbox-inline">
                    <input type="checkbox" id="update-all-captions">
                    Update all captions from Google Photos
                </label>
                <p class="help-text" style="margin: 4px 0 0 26px;">
                    Check this to re-fetch captions for all photos (slower). Otherwise, only new photos get captions.
                </p>
            </div>
            <button id="btn-sync" class="btn btn-primary">Sync Now</button>
            <div id="sync-progress" class="sync-progress-box">
                <div id="sync-stage">Starting sync...</div>
                <div id="sync-details"></div>
                <div class="progress-bar-container">
                    <div id="sync-progress-bar"></div>
                </div>
                <div id="sync-progress-text"></div>
            </div>
        </section>

        <!-- Albums Tab -->
        <section id="albums" class="tab-content">
            <h2>Google Photos Albums</h2>

            <div class="form-group">
                <label for="new-album-url">Add Album URL</label>
                <input type="url" id="new-album-url" placeholder="https://photos.app.goo.gl/...">
            </div>
            <div class="form-group">
                <label for="new-album-name">Album Name (optional)</label>
                <input type="text" id="new-album-name" placeholder="My Album">
            </div>
            <button id="btn-add-album" class="btn btn-primary">Add Album</button>

            <h3>Configured Albums</h3>
            <p class="hint">Changes in album selection take effect immediately.</p>
            <ul id="album-list" class="album-list">
                <!-- Albums will be loaded here -->
            </ul>
        </section>

        <!-- Display Tab -->
        <section id="display" class="tab-content">
            <h2>Display Settings</h2>
            <p class="hint">Changes take effect immediately after saving.</p>

            <div class="form-group">
                <label for="photo-duration">Photo Duration (seconds)</label>
                <input type="number" id="photo-duration" min="5" max="300"
                       value="{{ config.display.photo_duration_seconds }}">
            </div>

            <div class="form-group">
                <label for="transition-type">Transition Type</label>
                <select id="transition-type">
                    <option value="fade" {% if config.display.transition_type == 'fade' %}selected{% endif %}>Fade</option>
                    <option value="slide_left" {% if config.display.transition_type == 'slide_left' %}selected{% endif %}>Slide Left</option>
                    <option value="slide_right" {% if config.display.transition_type == 'slide_right' %}selected{% endif %}>Slide Right</option>
                    <option value="slide_up" {% if config.display.transition_type == 'slide_up' %}selected{% endif %}>Slide Up</option>
                    <option value="slide_down" {% if config.display.transition_type == 'slide_down' %}selected{% endif %}>Slide Down</option>
                    <option value="random" {% if config.display.transition_type == 'random' %}selected{% endif %}>Random</option>
                </select>
            </div>

            <div class="form-group">
                <label for="display-order">Photo Order</label>
                <select id="display-order">
                    <option value="random" {% if config.display.order == 'random' %}selected{% endif %}>Random</option>
                    <option value="sequential" {% if config.display.order == 'sequential' %}selected{% endif %}>Sequential</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="ken-burns-enabled"
                           {% if config.ken_burns.enabled %}checked{% endif %}>
                    Enable Ken Burns Effect
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="overlay-enabled"
                           {% if config.overlay.enabled %}checked{% endif %}>
                    Show Date/Caption Overlay
                </label>
            </div>

            <div class="form-group" id="overlay-font-size-group" style="display: flex; align-items: center; gap: 12px;">
                <label for="overlay-font-size" style="margin: 0;">Overlay Text Size (pixels)</label>
                <input type="number" id="overlay-font-size" min="12" max="200"
                       value="{{ config.overlay.font_size }}" style="width: 100px;">
            </div>

            <button id="btn-save-display" class="btn btn-primary">Save Display Settings</button>
        </section>

        <!-- Schedule Tab -->
        <section id="schedule" class="tab-content">
            <h2>Schedule Settings</h2>
            <p class="hint">Changes take effect immediately after saving. However Slideshow Control must be used to enable/disable the schedule.</p>

            <h3>Weekday Schedule (Mon-Fri)</h3>
            <div class="time-range">
                <div class="form-group">
                    <label for="weekday-start">Start Time</label>
                    <input type="time" id="weekday-start"
                           value="{{ config.schedule.weekday.start_time }}">
                </div>
                <div class="form-group">
                    <label for="weekday-end">End Time</label>
                    <input type="time" id="weekday-end"
                           value="{{ config.schedule.weekday.end_time }}">
                </div>
            </div>

            <h3>Weekend Schedule (Sat-Sun)</h3>
            <div class="time-range">
                <div class="form-group">
                    <label for="weekend-start">Start Time</label>
                    <input type="time" id="weekend-start"
                           value="{{ config.schedule.weekend.start_time }}">
                </div>
                <div class="form-group">
                    <label for="weekend-end">End Time</label>
                    <input type="time" id="weekend-end"
                           value="{{ config.schedule.weekend.end_time }}">
                </div>
            </div>

            <div class="form-group">
                <label for="off-hours-mode">Off-Hours Display</label>
                <select id="off-hours-mode">
                    <option value="black" {% if config.schedule.off_hours_mode == 'black' %}selected{% endif %}>Black Screen</option>
                    <option value="clock" {% if config.schedule.off_hours_mode == 'clock' %}selected{% endif %}>Clock</option>
                </select>
            </div>

            <button id="btn-save-schedule" class="btn btn-primary">Save Schedule</button>
        </section>

        <!-- Cache Tab -->
        <section id="cache" class="tab-content">
            <h2>Cache Management</h2>

            <div class="status-box">
                <p><strong>Cache Directory:</strong> {{ config.cache.directory }}</p>
                <p><strong>Max Size:</strong> {{ config.cache.max_size_mb }} MB</p>
                <p><strong>Current Size:</strong> <span id="cache-size-detail">-</span> MB</p>
                <p><strong>Photos:</strong> <span id="photo-count-detail">-</span></p>
                <p><strong>Videos:</strong> <span id="video-count-detail">-</span></p>
            </div>

            <h3>Cached Photos <span id="photo-grid-count" style="font-weight: normal; font-size: 14px; color: #81d4fa;"></span></h3>
            <div id="photo-grid" class="photo-grid" style="max-height: 500px; overflow-y: auto; border: 1px solid #333; border-radius: 8px; padding: 10px; background: #16213e;">
                <!-- Thumbnails will be loaded here -->
            </div>

            <button id="btn-clear-cache" class="btn btn-danger" style="margin-top: 15px;">Clear Cache</button>
        </section>

        <footer class="copyright">
            Copyright © Luc Vincent, 2025 — All Rights Reserved
        </footer>
    </div>

    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then((registration) => {
                    console.log('ServiceWorker registered:', registration.scope);
                })
                .catch((error) => {
                    console.log('ServiceWorker registration failed:', error);
                });
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // API helpers
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = { method };
            if (data) {
                options.headers = { 'Content-Type': 'application/json' };
                options.body = JSON.stringify(data);
            }
            const response = await fetch(endpoint, options);
            return response.json();
        }

        // Load status
        async function loadStatus() {
            try {
                const status = await apiCall('/api/status');

                if (status.schedule) {
                    // Map scheduler state to user-friendly display
                    const stateEl = document.getElementById('state');
                    const state = status.schedule.state;
                    const isPaused = status.photo_control && status.photo_control.paused;
                    let displayText, badgeClass;

                    if (state === 'active' || state === 'force_on') {
                        if (isPaused) {
                            displayText = 'Paused';
                            badgeClass = 'status-badge paused';
                        } else {
                            displayText = 'Running';
                            badgeClass = 'status-badge running';
                        }
                    } else if (state === 'off_hours') {
                        displayText = 'Off-Hours';
                        badgeClass = 'status-badge off-hours';
                    } else if (state === 'force_off') {
                        displayText = 'Stopped';
                        badgeClass = 'status-badge stopped';
                    } else {
                        displayText = state;
                        badgeClass = 'status-badge';
                    }

                    stateEl.textContent = displayText;
                    stateEl.className = badgeClass;

                    if (status.schedule.next_transition && status.schedule.next_transition.time) {
                        const nextTime = new Date(status.schedule.next_transition.time);
                        const timeStr = nextTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        document.getElementById('next-transition').textContent =
                            `${status.schedule.next_transition.description} at ${timeStr}`;
                    } else if (status.schedule.has_override) {
                        document.getElementById('next-transition').textContent = 'None (manual control active)';
                    } else if (!status.schedule_enabled) {
                        document.getElementById('next-transition').textContent = 'None (schedule disabled)';
                    } else {
                        document.getElementById('next-transition').textContent = '-';
                    }
                }

                if (status.cache) {
                    document.getElementById('photo-count').textContent = status.cache.counts.photos;
                    document.getElementById('cache-size').textContent = status.cache.size_mb;
                    document.getElementById('photo-count-detail').textContent = status.cache.counts.photos;
                    document.getElementById('video-count-detail').textContent = status.cache.counts.videos;
                    document.getElementById('cache-size-detail').textContent = status.cache.size_mb;
                }

                // Update button states based on current state
                if (status.schedule) {
                    const state = status.schedule.state;
                    const isRunning = (state === 'active' || state === 'force_on');

                    // Show Start when stopped/off-hours, Show Stop when running
                    const startBtn = document.getElementById('btn-start');
                    const stopBtn = document.getElementById('btn-stop');
                    startBtn.style.display = isRunning ? 'none' : '';
                    stopBtn.style.display = isRunning ? '' : 'none';
                }

                // Sync schedule enabled checkbox
                if (status.schedule_enabled !== undefined) {
                    document.getElementById('schedule-enabled-control').checked = status.schedule_enabled;
                }

                // Show/hide pause schedule button based on schedule enabled and state
                const tempOverrideInfo = document.getElementById('temp-override-info');
                const pauseScheduleBtn = document.getElementById('btn-pause-schedule');

                if (status.schedule_enabled) {
                    // Check for temporary override
                    if (status.schedule && status.schedule.has_temporary_override) {
                        tempOverrideInfo.style.display = 'block';
                        pauseScheduleBtn.style.display = 'none';

                        // Format the expiration time
                        const until = new Date(status.schedule.temporary_override_until);
                        document.getElementById('temp-override-until').textContent = until.toLocaleString();
                    } else {
                        tempOverrideInfo.style.display = 'none';
                        // Only show Pause Schedule button during off-hours
                        const state = status.schedule.state;
                        if (state === 'off_hours') {
                            pauseScheduleBtn.style.display = 'inline-block';
                        } else {
                            pauseScheduleBtn.style.display = 'none';
                        }
                    }
                } else {
                    pauseScheduleBtn.style.display = 'none';
                    tempOverrideInfo.style.display = 'none';
                }

                // Update photo control pause button
                if (status.photo_control) {
                    const pauseBtn = document.getElementById('btn-pause');
                    const statusEl = document.getElementById('photo-control-status');
                    if (status.photo_control.paused) {
                        pauseBtn.textContent = 'Resume';
                        pauseBtn.className = 'btn btn-success';
                        statusEl.innerHTML = '<strong style="color: var(--warning);">Slideshow paused.</strong> Click Resume to continue auto-advance.';
                        statusEl.style.color = 'var(--text-secondary)';
                    } else {
                        pauseBtn.textContent = 'Pause';
                        pauseBtn.className = 'btn btn-primary';
                        statusEl.textContent = 'Use these controls to navigate photos or pause the slideshow on a specific photo.';
                        statusEl.style.color = '';
                    }
                }

                document.getElementById('status-indicator').textContent = 'Connected';
                document.getElementById('status-indicator').className = 'status online';
            } catch (e) {
                document.getElementById('status-indicator').textContent = 'Disconnected';
                document.getElementById('status-indicator').className = 'status offline';
            }
        }

        // Load albums
        async function loadAlbums() {
            const albums = await apiCall('/api/albums');
            const list = document.getElementById('album-list');
            list.innerHTML = '';
            albums.forEach((album, index) => {
                const li = document.createElement('li');
                li.dataset.index = index;
                const displayName = album.name || 'Unnamed album';
                li.innerHTML = `
                    <label class="album-enabled-label">
                        <input type="checkbox" class="album-enabled-checkbox"
                               data-index="${index}" ${album.enabled ? 'checked' : ''}>
                        <span>Show</span>
                    </label>
                    <div class="album-details">
                        <div class="album-name-row">
                            <span class="album-name-wrapper">
                                <span class="album-name editable" data-index="${index}">${displayName}</span>
                                <span class="album-photo-count">(${album.photo_count} photos)</span>
                            </span>
                            <span class="album-edit-wrapper hidden">
                                <input type="text" class="album-name-input" data-index="${index}"
                                       value="${album.name || ''}" placeholder="Album name">
                                <button class="btn btn-small btn-save" data-index="${index}">Save</button>
                            </span>
                        </div>
                        <div class="album-url">${album.url}</div>
                    </div>
                    <button class="btn btn-small btn-danger" onclick="deleteAlbum(${index})">Delete</button>
                `;
                list.appendChild(li);
            });

            // Add event handlers for enabled checkboxes
            document.querySelectorAll('.album-enabled-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', async (e) => {
                    const index = e.target.dataset.index;
                    const enabled = e.target.checked;
                    await apiCall(`/api/albums/${index}/enabled`, 'POST', { enabled });
                });
            });

            // Click on album name to edit
            document.querySelectorAll('.album-name.editable').forEach(nameSpan => {
                nameSpan.addEventListener('click', (e) => {
                    const li = e.target.closest('li');
                    li.querySelector('.album-name-wrapper').classList.add('hidden');
                    li.querySelector('.album-edit-wrapper').classList.remove('hidden');
                    const input = li.querySelector('.album-name-input');
                    input.focus();
                    input.select();
                });
            });

            // Save button handler
            document.querySelectorAll('.btn-save').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const li = e.target.closest('li');
                    const input = li.querySelector('.album-name-input');
                    const index = input.dataset.index;
                    const name = input.value.trim();
                    await apiCall(`/api/albums/${index}/name`, 'POST', { name });
                    // Update display and switch back to view mode
                    li.querySelector('.album-name').textContent = name || 'Unnamed album';
                    li.querySelector('.album-name-wrapper').classList.remove('hidden');
                    li.querySelector('.album-edit-wrapper').classList.add('hidden');
                });
            });

            // Keyboard handlers for input
            document.querySelectorAll('.album-name-input').forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const li = e.target.closest('li');
                        li.querySelector('.btn-save').click();
                    } else if (e.key === 'Escape') {
                        // Cancel edit
                        const li = e.target.closest('li');
                        li.querySelector('.album-name-wrapper').classList.remove('hidden');
                        li.querySelector('.album-edit-wrapper').classList.add('hidden');
                    }
                });
            });
        }

        // Add album
        document.getElementById('btn-add-album').addEventListener('click', async () => {
            const url = document.getElementById('new-album-url').value;
            const name = document.getElementById('new-album-name').value;
            if (!url) {
                alert('Please enter an album URL');
                return;
            }
            await apiCall('/api/albums', 'POST', { url, name });
            document.getElementById('new-album-url').value = '';
            document.getElementById('new-album-name').value = '';
            loadAlbums();
        });

        // Delete album
        async function deleteAlbum(index) {
            if (confirm('Delete this album?')) {
                await apiCall(`/api/albums/${index}`, 'DELETE');
                loadAlbums();
            }
        }

        // Control buttons
        document.getElementById('btn-start').addEventListener('click', () => {
            apiCall('/api/control/start', 'POST');
            setTimeout(loadStatus, 500);
        });
        document.getElementById('btn-stop').addEventListener('click', () => {
            apiCall('/api/control/stop', 'POST');
            setTimeout(loadStatus, 500);
        });
        document.getElementById('btn-next').addEventListener('click', () => {
            apiCall('/api/control/next', 'POST');
        });

        // Photo control buttons
        document.getElementById('btn-prev').addEventListener('click', () => {
            apiCall('/api/control/prev', 'POST');
        });

        document.getElementById('btn-pause').addEventListener('click', () => {
            apiCall('/api/control/toggle_pause', 'POST');
            setTimeout(loadStatus, 300);
        });

        // Schedule enabled checkbox - immediate save
        document.getElementById('schedule-enabled-control').addEventListener('change', async (e) => {
            const enabled = e.target.checked;
            await apiCall('/api/schedule/enabled', 'POST', { enabled });
            setTimeout(loadStatus, 500);
        });

        // Pause Schedule button - temporary override
        document.getElementById('btn-pause-schedule').addEventListener('click', async () => {
            await apiCall('/api/control/start_temp', 'POST');
            setTimeout(loadStatus, 500);
        });

        // Resume Schedule button - clear temporary override
        document.getElementById('btn-resume-schedule').addEventListener('click', async () => {
            await apiCall('/api/control/resume', 'POST');
            setTimeout(loadStatus, 500);
        });

        // Sync progress polling
        let syncPollInterval = null;

        async function updateSyncProgress() {
            try {
                const progress = await apiCall('/api/sync/status');
                const progressDiv = document.getElementById('sync-progress');
                const stageDiv = document.getElementById('sync-stage');
                const detailsDiv = document.getElementById('sync-details');
                const progressBar = document.getElementById('sync-progress-bar');
                const progressText = document.getElementById('sync-progress-text');
                const syncBtn = document.getElementById('btn-sync');

                if (progress.is_syncing) {
                    progressDiv.style.display = 'block';
                    syncBtn.disabled = true;
                    syncBtn.textContent = 'Syncing...';

                    if (progress.stage === 'scraping') {
                        stageDiv.textContent = `Scraping album: ${progress.album_name || 'Loading...'}`;
                        detailsDiv.textContent = `Found ${progress.urls_found} photos so far...`;
                        // Indeterminate progress during scraping
                        progressBar.style.width = '100%';
                        progressBar.style.background = 'linear-gradient(90deg, #4CAF50 25%, #8BC34A 50%, #4CAF50 75%)';
                        progressBar.style.backgroundSize = '200% 100%';
                        progressBar.style.animation = 'shimmer 1.5s infinite';
                        progressText.textContent = `Album ${progress.albums_done}/${progress.albums_total}`;
                    } else if (progress.stage === 'downloading') {
                        stageDiv.textContent = 'Downloading photos...';
                        const pct = progress.downloads_total > 0
                            ? Math.round((progress.downloads_done / progress.downloads_total) * 100)
                            : 0;
                        detailsDiv.textContent = `${progress.downloads_done} of ${progress.downloads_total} new photos`;
                        progressBar.style.width = pct + '%';
                        progressBar.style.background = '#4CAF50';
                        progressBar.style.animation = 'none';
                        progressText.textContent = pct + '%';
                    } else if (progress.stage === 'fetching_captions') {
                        stageDiv.textContent = 'Fetching captions from Google Photos...';
                        const pct = progress.downloads_total > 0
                            ? Math.round((progress.downloads_done / progress.downloads_total) * 100)
                            : 0;
                        detailsDiv.textContent = `${progress.downloads_done} of ${progress.downloads_total} photos`;
                        progressBar.style.width = pct + '%';
                        progressBar.style.background = 'linear-gradient(90deg, var(--sage-primary), var(--sage-light))';
                        progressBar.style.animation = 'none';
                        progressText.textContent = pct + '%';
                    }
                } else if (progress.stage === 'complete') {
                    stageDiv.textContent = 'Sync complete!';
                    detailsDiv.textContent = `Found ${progress.urls_found} photos total`;
                    progressBar.style.width = '100%';
                    progressBar.style.background = '#4CAF50';
                    progressBar.style.animation = 'none';
                    progressText.textContent = '100%';
                    syncBtn.disabled = false;
                    syncBtn.textContent = 'Sync Now';

                    // Hide progress after 3 seconds
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                        loadStatus();
                    }, 3000);

                    // Stop polling
                    if (syncPollInterval) {
                        clearInterval(syncPollInterval);
                        syncPollInterval = null;
                    }
                } else {
                    // Idle state
                    progressDiv.style.display = 'none';
                    syncBtn.disabled = false;
                    syncBtn.textContent = 'Sync Now';
                    if (syncPollInterval) {
                        clearInterval(syncPollInterval);
                        syncPollInterval = null;
                    }
                }
            } catch (e) {
                console.error('Error polling sync status:', e);
            }
        }

        // Sync button
        document.getElementById('btn-sync').addEventListener('click', async () => {
            const progressDiv = document.getElementById('sync-progress');
            const stageDiv = document.getElementById('sync-stage');
            const detailsDiv = document.getElementById('sync-details');
            const progressBar = document.getElementById('sync-progress-bar');
            const updateAllCaptions = document.getElementById('update-all-captions').checked;

            // Show progress immediately
            progressDiv.style.display = 'block';
            stageDiv.textContent = 'Starting sync...';
            detailsDiv.textContent = '';
            progressBar.style.width = '0%';

            document.getElementById('btn-sync').disabled = true;
            document.getElementById('btn-sync').textContent = 'Syncing...';

            await apiCall('/api/sync', 'POST', { update_all_captions: updateAllCaptions });

            // Start polling for progress
            if (!syncPollInterval) {
                syncPollInterval = setInterval(updateSyncProgress, 1000);
            }
        });

        // Check sync status on page load and start polling if sync is in progress
        async function checkInitialSyncStatus() {
            try {
                const progress = await apiCall('/api/sync/status');
                if (progress.is_syncing && !syncPollInterval) {
                    // Sync is already running, start polling
                    syncPollInterval = setInterval(updateSyncProgress, 1000);
                }
                updateSyncProgress();
            } catch (e) {
                console.error('Error checking initial sync status:', e);
            }
        }
        checkInitialSyncStatus();

        // Load photos
        async function loadPhotos() {
            const photos = await apiCall('/api/photos');
            const grid = document.getElementById('photo-grid');
            const countSpan = document.getElementById('photo-grid-count');
            grid.innerHTML = '';

            const photoItems = photos.filter(p => p.type === 'photo');
            countSpan.textContent = `(${photoItems.length} photos)`;

            photoItems.forEach(photo => {
                const div = document.createElement('div');
                div.className = 'photo-thumb';
                div.innerHTML = `
                    <img src="/api/photos/${photo.id}/thumbnail"
                         alt="${photo.caption || ''}"
                         loading="lazy">
                    <span>${photo.caption || photo.date || ''}</span>
                `;
                grid.appendChild(div);
            });
        }

        // Clear cache button
        document.getElementById('btn-clear-cache').addEventListener('click', async () => {
            if (confirm('Are you sure you want to clear all cached photos? They will be re-downloaded on the next sync.')) {
                const btn = document.getElementById('btn-clear-cache');
                btn.disabled = true;
                btn.textContent = 'Clearing...';
                try {
                    const result = await apiCall('/api/cache/clear', 'POST');
                    if (result.success) {
                        alert('Cache cleared successfully. Run sync to re-download photos.');
                        loadStatus();
                        loadPhotos();
                    } else {
                        alert('Error: ' + (result.error || 'Unknown error'));
                    }
                } catch (e) {
                    alert('Error clearing cache: ' + e);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Clear Cache';
                }
            }
        });

        // Track display settings changes
        const displayInputs = ['photo-duration', 'transition-type', 'display-order', 'ken-burns-enabled', 'overlay-enabled', 'overlay-font-size'];
        const displayOriginalValues = {};

        function captureDisplayOriginalValues() {
            displayInputs.forEach(id => {
                const el = document.getElementById(id);
                displayOriginalValues[id] = el.type === 'checkbox' ? el.checked : el.value;
            });
        }

        function checkDisplayChanges() {
            const btn = document.getElementById('btn-save-display');
            let hasChanges = false;
            displayInputs.forEach(id => {
                const el = document.getElementById(id);
                const currentValue = el.type === 'checkbox' ? el.checked : el.value;
                if (currentValue !== displayOriginalValues[id]) {
                    hasChanges = true;
                }
            });
            btn.disabled = !hasChanges;
        }

        // Initialize original values and set up change listeners
        captureDisplayOriginalValues();
        document.getElementById('btn-save-display').disabled = true;
        displayInputs.forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('change', checkDisplayChanges);
            if (el.type === 'number' || el.type === 'text') {
                el.addEventListener('input', checkDisplayChanges);
            }
        });

        // Save display settings
        document.getElementById('btn-save-display').addEventListener('click', async () => {
            const btn = document.getElementById('btn-save-display');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const data = {
                    photo_duration_seconds: document.getElementById('photo-duration').value,
                    transition_type: document.getElementById('transition-type').value,
                    order: document.getElementById('display-order').value,
                    ken_burns_enabled: document.getElementById('ken-burns-enabled').checked,
                    overlay_enabled: document.getElementById('overlay-enabled').checked,
                    overlay_font_size: document.getElementById('overlay-font-size').value
                };

                const result = await apiCall('/api/display', 'POST', data);
                if (result.success) {
                    captureDisplayOriginalValues();  // Reset tracking
                    btn.textContent = 'Saved!';
                    setTimeout(() => {
                        btn.textContent = 'Save Display Settings';
                        // Button stays disabled since no changes now
                    }, 1500);
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                    btn.textContent = 'Save Display Settings';
                    btn.disabled = false;
                }
            } catch (e) {
                alert('Error saving settings: ' + e);
                btn.textContent = 'Save Display Settings';
                btn.disabled = false;
            }
        });

        // Track schedule settings changes
        const scheduleInputs = ['weekday-start', 'weekday-end', 'weekend-start', 'weekend-end', 'off-hours-mode'];
        const scheduleOriginalValues = {};

        function captureScheduleOriginalValues() {
            scheduleInputs.forEach(id => {
                const el = document.getElementById(id);
                scheduleOriginalValues[id] = el.value;
            });
        }

        function checkScheduleChanges() {
            const btn = document.getElementById('btn-save-schedule');
            let hasChanges = false;
            scheduleInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el.value !== scheduleOriginalValues[id]) {
                    hasChanges = true;
                }
            });
            btn.disabled = !hasChanges;
        }

        // Initialize schedule tracking
        captureScheduleOriginalValues();
        document.getElementById('btn-save-schedule').disabled = true;
        scheduleInputs.forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('change', checkScheduleChanges);
            el.addEventListener('input', checkScheduleChanges);
        });

        // Save schedule settings
        document.getElementById('btn-save-schedule').addEventListener('click', async () => {
            const btn = document.getElementById('btn-save-schedule');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const data = {
                    weekday_start: document.getElementById('weekday-start').value,
                    weekday_end: document.getElementById('weekday-end').value,
                    weekend_start: document.getElementById('weekend-start').value,
                    weekend_end: document.getElementById('weekend-end').value,
                    off_hours_mode: document.getElementById('off-hours-mode').value
                };

                const result = await apiCall('/api/schedule', 'POST', data);
                if (result.success) {
                    captureScheduleOriginalValues();
                    btn.textContent = 'Saved!';
                    setTimeout(() => {
                        btn.textContent = 'Save Schedule';
                    }, 1500);
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                    btn.textContent = 'Save Schedule';
                    btn.disabled = false;
                }
            } catch (e) {
                alert('Error saving schedule: ' + e);
                btn.textContent = 'Save Schedule';
                btn.disabled = false;
            }
        });

        // Initialize
        loadStatus();
        loadAlbums();
        loadPhotos();
        setInterval(loadStatus, 10000);
    </script>
</body>
</html>
